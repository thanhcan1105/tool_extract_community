/**
 * Hello, u're looking to steal my code, good luck!
 * If I were you I would at least ask permission before that,
 * I would be happy instead of you stealing my code and having to take drastic measures.
 * Well, thank you, Gabriel Aplok.
 *
 * It took me about 4-6 months to design all of this systems. ❤️
*/

import*as e from"@minecraft/server";let IMPACT_EFFECTS={dirt:{tags:["dirt","sand","grass","snow"]},foliage:{tags:["plant","crop","fertilize_area"]},gravel:{tags:["gravel"]},glass:{ids:["minecraft:glass","minecraft:glass_pane","minecraft:hard_glass","minecraft:hard_glass_pane","minecraft:tinted_glass","minecraft:stained_glass","minecraft:stained_glass_pane","minecraft:hard_stained_glass","minecraft:hard_stained_glass_pane"],sparks:!0,numSparks:2},masonry:{tags:["stone"],sparks:!0,numSparks:1},metal:{tags:["metal","rail","mob_spawner"],sparks:!0,numSparks:3},wood:{tags:["wood","pumpkin","text_sign"]}},HOLE_IGNORED_BLOCKS=["minecraft:bamboo","minecraft:big_dripleaf","minecraft:cocoa","minecraft:carved_pumpkin","minecraft:chorus_flower","minecraft:chorus_plant","minecraft:cave_vines","minecraft:cave_vines_body_with_berries","minecraft:cave_vines_head_with_berries","minecraft:glass","minecraft:glass_pane","minecraft:lantern","minecraft:lit_pumpkin","minecraft:melon_block","minecraft:pumpkin","minecraft:stained_glass","minecraft:stained_glass_pane","minecraft:standing_sign","minecraft:small_dripleaf_block","minecraft:tinted_glass","minecraft:turtle_egg","minecraft:vine","minecraft:wall_banner","minecraft:wall_sign","minecraft:web","minecraft:wheat","minecraft:waterlily"],DAMAGE={bullet_1:{caliber:"9x19pr",damage:8},bullet_2:{caliber:"bullet_12gauge",damage:24},bullet_3:{caliber:"bullet_50ae",damage:16},bullet_4:{caliber:"bullet_556x45",damage:10},bullet_5:{caliber:"bullet_762x39",damage:12},bullet_6:{caliber:"bullet_762x51",damage:14}},NERFED_ENTITIES=["gabrielaplok:soldier"];function hasTagsInBlock(e,a){let t=0;for(let r of e.getTags())if(a.includes(r)){t+=1;break}return t}function playImpactEffect(e,a,t=!1,r=0){if(e&&(a&&e.runCommand(`playsound bullet.impact.${a} @a[r=20] ~~~ 1 1 0.01`),!e.hasTag("in_water")&&t&&r>=1))for(let n=0;n<r;n+=1)e.runCommand("particle gabrielaplok:bullet_sparks ^^^")}e.system.beforeEvents.watchdogTerminate.subscribe(e=>{e.cancel=!0}),e.world.afterEvents.projectileHitEntity.subscribe(a=>{try{let t=a.source,r=a.projectile;if(!r||"gabrielaplok:bullet"!=r.typeId)return;let n=a.getEntityHit();if(!n)return;let i=n.entity;if(!i||!i.typeId)return;let l=r.getComponent(e.EntityVariantComponent.componentId)?.value;if(!l)return;let s=DAMAGE[`bullet_${l}`];if(!s)return;let c=s.damage;t.isSneaking&&(c=Math.round(1.14*c)),NERFED_ENTITIES.includes(t.typeId)&&(c=Math.round(.24*c));let m=i;if(i.applyDamage(c,{cause:e.EntityDamageCause.suicide,damagingEntity:t,damagingProjectile:r})){let g=i.getComponent(e.EntityHealthComponent.componentId)?.currentValue;g<1&&m instanceof e.Player&&t.sendMessage(`${t.nameTag} killed ${m.nameTag} with a gun.`)}i.runCommand("playsound bullet.impact.body @a[r=20] ~~~ 0.5 1 0.01"),t instanceof e.Player&&t.triggerEvent("gabrielaplok:hitmark")}catch(o){return}}),e.world.afterEvents.projectileHitBlock.subscribe(e=>{try{let a=e.projectile;if(!a||"gabrielaplok:bullet"!=a.typeId)return;let t=e.getBlockHit();if(!t)return;let r=t.block;if(!r)return;for(let n in IMPACT_EFFECTS){let i=IMPACT_EFFECTS[n];if(i.tags&&hasTagsInBlock(r,i.tags)>=1||i.ids&&i.ids.includes(r.typeId)){playImpactEffect(a,n,i.sparks,i.numSparks,i.water);break}}if(HOLE_IGNORED_BLOCKS.includes(r.typeId))return;a.triggerEvent("gabrielaplok:hole")}catch(l){return}});